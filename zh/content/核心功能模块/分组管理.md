# 分组管理

`GroupManager` 类负责管理 VS Code RepoWiki 扩展中的文件分组功能，包括虚拟分组和物理分组两种模式。

## 概述

### 分组类型

| 类型 | 说明 | 示例 |
|------|------|------|
| **虚拟分组** | 用户自定义的分组，可跨越物理目录组织文件 | 将 `docs/api.md` 和 `guides/intro.md` 归入"入门指南"组 |
| **物理分组** | 基于文件系统目录自动生成的分组 | `src/` 目录下的文件自动归入"src"组 |

### 默认分组

未加入任何虚拟分组的文件自动归入 **"未分类"** 默认分组。

---

## 配置结构

分组配置存储在 VS Code 工作区设置中（`repowiki.*`）：

```typescript
// package.json 中的配置定义
{
  "repowiki.groups": {
    "type": "object",
    "default": {},
    "description": "虚拟分组配置：分组名 -> 文件路径数组"
  },
  "repowiki.directoryAliases": {
    "type": "object",
    "default": {},
    "description": "目录别名配置：目录路径 -> 显示别名"
  },
  "repowiki.initialized": {
    "type": "boolean",
    "default": false,
    "description": "是否已完成初始化"
  }
}
```

### 配置示例

```json
{
  "repowiki.groups": {
    "入门指南": [
      "docs/intro.md",
      "guides/getting-started.md"
    ],
    "API 参考": [
      "docs/api/core.md",
      "docs/api/utils.md"
    ]
  },
  "repowiki.directoryAliases": {
    "docs": "文档",
    "src/components": "组件"
  }
}
```

---

## API 文档

### 构造函数

```typescript
constructor(context: vscode.ExtensionContext)
```

### 获取分组配置

#### `getGroups()`

获取所有虚拟分组配置。

```typescript
getGroups(): GroupConfig
```

**返回值：** `GroupConfig` - 分组名到文件路径数组的映射

**示例：**
```typescript
const groups = groupManager.getGroups();
// { "入门指南": ["docs/intro.md"], "API": ["docs/api.md"] }
```

---

#### `getDirectoryAliases()`

获取目录别名配置。

```typescript
getDirectoryAliases(): DirectoryAliasConfig
```

**示例：**
```typescript
const aliases = groupManager.getDirectoryAliases();
// { "docs": "文档", "src": "源码" }
```

---

### 目录别名管理

#### `setDirectoryAlias()`

为目录设置显示别名。

```typescript
async setDirectoryAlias(directoryPath: string, alias: string): Promise<boolean>
```

**参数：**
- `directoryPath` - 目录的相对路径
- `alias` - 显示别名

**示例：**
```typescript
await groupManager.setDirectoryAlias('docs', '文档');
// "docs" 目录在树视图中显示为 "文档"
```

---

#### `getDirectoryDisplayName()`

获取目录的显示名称（优先返回别名）。

```typescript
getDirectoryDisplayName(directoryPath: string): string
```

**示例：**
```typescript
groupManager.getDirectoryDisplayName('docs');      // "文档"（如果设置了别名）
groupManager.getDirectoryDisplayName('src');       // "src"（无别名时返回原路径）
groupManager.getDirectoryDisplayName('');          // "根目录"
```

---

### 初始化状态

#### `isInitialized()`

检查扩展是否已完成初始化。

```typescript
isInitialized(): boolean
```

---

#### `markInitialized()`

标记扩展为已初始化状态。

```typescript
async markInitialized(): Promise<void>
```

---

### 文件分组查询

#### `getFileGroup()`

获取文件所属的分组信息。

```typescript
getFileGroup(relativePath: string): { groupName: string; isPhysical: boolean }
```

**返回值：**
- `groupName` - 分组名称
- `isPhysical` - 是否为物理分组

**逻辑：**
1. 优先查找虚拟分组
2. 未找到则返回物理目录分组

**示例：**
```typescript
// 假设 "docs/intro.md" 在虚拟分组 "入门指南" 中
groupManager.getFileGroup('docs/intro.md');
// { groupName: "入门指南", isPhysical: false }

// 假设 "src/utils.ts" 不在任何虚拟分组中
groupManager.getFileGroup('src/utils.ts');
// { groupName: "src", isPhysical: true }
```

---

#### `getPhysicalGroups()`

从文件列表中提取所有物理分组（目录）。

```typescript
async getPhysicalGroups(files: Array<{ relativePath: string }>): Promise<Map<string, string>>
```

**返回值：** `Map<目录路径, 显示名称>`

**示例：**
```typescript
const files = [
  { relativePath: 'docs/intro.md' },
  { relativePath: 'docs/guide.md' },
  { relativePath: 'src/index.ts' }
];

const groups = await groupManager.getPhysicalGroups(files);
// Map { "docs" => "文档", "src" => "src" }
```

---

### 虚拟分组管理

#### `createGroup()`

创建新的虚拟分组。

```typescript
async createGroup(name: string): Promise<boolean>
```

**限制：**
- 不能使用 "未分类" 作为分组名（保留给默认分组）
- 不能创建已存在的分组

**示例：**
```typescript
const success = await groupManager.createGroup('新功能文档');
if (success) {
  vscode.window.showInformationMessage('分组创建成功');
}
```

---

#### `deleteGroup()`

删除虚拟分组（文件自动移至物理分组）。

```typescript
async deleteGroup(name: string): Promise<boolean>
```

**限制：** 不能删除默认分组 "未分类"

**示例：**
```typescript
await groupManager.deleteGroup('旧文档');
// 该分组中的文件将按物理目录重新归类
```

---

#### `renameGroup()`

重命名虚拟分组。

```typescript
async renameGroup(oldName: string, newName: string): Promise<boolean>
```

**限制：** 不能重命名默认分组 "未分类"

**示例：**
```typescript
await groupManager.renameGroup('临时分组', '正式文档');
```

---

#### `moveFileToGroup()`

将文件移动到指定虚拟分组。

```typescript
async moveFileToGroup(relativePath: string, groupName: string): Promise<boolean>
```

**行为：**
1. 从所有现有虚拟分组中移除该文件
2. 添加到目标虚拟分组
3. 如果目标分组不存在，自动创建

**示例：**
```typescript
// 将文件从当前分组移动到 "API 参考" 分组
await groupManager.moveFileToGroup('docs/new-api.md', 'API 参考');
```

---

#### `getAllVirtualGroupNames()`

获取所有虚拟分组的名称列表。

```typescript
getAllVirtualGroupNames(): string[]
```

**示例：**
```typescript
const names = groupManager.getAllVirtualGroupNames();
// ["入门指南", "API 参考", "最佳实践"]
```

---

### 静态属性

#### `GroupManager.DEFAULT_GROUP`

获取默认分组名称常量。

```typescript
static get DEFAULT_GROUP(): string  // 返回 "未分类"
```

---

## 使用示例

### 基础用法

```typescript
import * as vscode from 'vscode';
import { GroupManager } from './groupManager';

export function activate(context: vscode.ExtensionContext) {
  const groupManager = new GroupManager(context);

  // 创建新分组
  await groupManager.createGroup('文档集合');

  // 移动文件到分组
  await groupManager.moveFileToGroup('docs/intro.md', '文档集合');

  // 设置目录别名
  await groupManager.setDirectoryAlias('docs', '文档');

  // 查询文件所属分组
  const { groupName, isPhysical } = groupManager.getFileGroup('docs/intro.md');
  console.log(`${groupName} (${isPhysical ? '物理' : '虚拟'}分组)`);
}
```

### 注册为 VS Code 命令

```typescript
// 创建分组命令
context.subscriptions.push(
  vscode.commands.registerCommand('repowiki.createGroup', async () => {
    const name = await vscode.window.showInputBox({
      prompt: '输入分组名称',
      placeHolder: '例如：入门指南'
    });

    if (name) {
      const groupManager = new GroupManager(context);
      const success = await groupManager.createGroup(name);
      if (success) {
        vscode.window.showInformationMessage(`分组 "${name}" 已创建`);
      }
    }
  })
);

// 移动文件到分组命令
context.subscriptions.push(
  vscode.commands.registerCommand('repowiki.moveFileToGroup', async (uri: vscode.Uri) => {
    const relativePath = vscode.workspace.asRelativePath(uri);
    const groupManager = new GroupManager(context);

    const groupNames = groupManager.getAllVirtualGroupNames();
    const selected = await vscode.window.showQuickPick(groupNames, {
      placeHolder: '选择目标分组'
    });

    if (selected) {
      await groupManager.moveFileToGroup(relativePath, selected);
      vscode.window.showInformationMessage(`已移动到 "${selected}"`);
    }
  })
);
```

### 在 TreeView 中使用

```typescript
import { TreeDataProvider, TreeNode } from './treeView';

class WikiTreeProvider implements TreeDataProvider<TreeNodeData> {
  constructor(private groupManager: GroupManager) {}

  getChildren(node?: TreeNodeData): TreeNodeData[] {
    if (!node) {
      // 返回所有分组（虚拟 + 物理）
      return this.getGroupsAsNodes();
    }

    if (node.type === 'group') {
      // 返回分组中的文件
      return this.getFilesInGroup(node.groupName!, node.isPhysical!);
    }

    return [];
  }

  private getGroupsAsNodes(): TreeNodeData[] {
    // 虚拟分组
    const virtualGroups = groupManager.getAllVirtualGroupNames()
      .map(name => ({
        type: 'group' as const,
        label: name,
        groupName: name,
        isPhysical: false
      }));

    // 物理分组（需要配合文件列表获取）
    // ...

    return virtualGroups;
  }
}
```

---

## 配置存储位置

分组配置保存在工作区的 `.vscode/settings.json` 文件中：

```json
{
  "repowiki.groups": {
    "入门指南": ["docs/intro.md", "docs/quickstart.md"]
  },
  "repowiki.directoryAliases": {
    "docs": "文档中心"
  },
  "repowiki.initialized": true
}
```

> **注意：** 配置存储在工作区级别（`ConfigurationTarget.Workspace`），因此不同工作区可以有不同的分组配置。
